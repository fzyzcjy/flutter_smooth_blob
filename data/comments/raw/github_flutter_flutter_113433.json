{"source": "github", "metadata": {"org": "flutter", "repo": "flutter", "issue": 113433}, "content": {"author": {"login": "fzyzcjy"}, "body": "This relands https://github.com/flutter/flutter/pull/112609, but with a flag that is off by default. The reason why it is designed like this can be found in discussions around https://github.com/flutter/flutter/pull/112609#issuecomment-1278889389.\r\n\r\nClose #112610\r\n\r\n## Pre-launch Checklist\r\n\r\n- [x] I read the [Contributor Guide] and followed the process outlined there for submitting PRs.\r\n- [x] I read the [Tree Hygiene] wiki page, which explains my responsibilities.\r\n- [x] I read and followed the [Flutter Style Guide], including [Features we expect every widget to implement].\r\n- [x] I signed the [CLA].\r\n- [x] I listed at least one issue that this PR fixes in the description above.\r\n- [x] I updated/added relevant documentation (doc comments with `///`).\r\n- [x] I added new tests to check the change I am making, or this PR is [test-exempt].\r\n- [ ] All existing and new tests are passing.\r\n\r\nIf you need help, consider asking for advice on the #hackers-new channel on [Discord].\r\n\r\n<!-- Links -->\r\n[Contributor Guide]: https://github.com/flutter/flutter/wiki/Tree-hygiene#overview\r\n[Tree Hygiene]: https://github.com/flutter/flutter/wiki/Tree-hygiene\r\n[test-exempt]: https://github.com/flutter/flutter/wiki/Tree-hygiene#tests\r\n[Flutter Style Guide]: https://github.com/flutter/flutter/wiki/Style-guide-for-Flutter-repo\r\n[Features we expect every widget to implement]: https://github.com/flutter/flutter/wiki/Style-guide-for-Flutter-repo#features-we-expect-every-widget-to-implement\r\n[CLA]: https://cla.developers.google.com/\r\n[flutter/tests]: https://github.com/flutter/tests\r\n[breaking change policy]: https://github.com/flutter/flutter/wiki/Tree-hygiene#handling-breaking-changes\r\n[Discord]: https://github.com/flutter/flutter/wiki/Chat\r\n", "comments": [{"id": "IC_kwDOAeUeuM5MQDMM", "author": {"login": "pdblasi-google"}, "authorAssociation": "CONTRIBUTOR", "body": "@fzyzcjy @CaseyHillers @goderbauer\r\n\r\nI still think that this change should be made without the boolean flag. The underlying issue with the goldens is that `pumpFrames` defines `interval` with microsecond precision, but the `AutomatedTestWidgetsFlutterBinding` didn't support microsecond precision. @Piinks and I went over a couple of golden changes in the flutter repos test as well and accepted the changes to those goldens as they were a change to a correct state (which is why the goldens are current hanging for this PR).\r\n\r\nThe secondary issue that makes this difficult to break cleanly is that `LiveWidgetsFlutterBinding` _does_ support microsecond precision, so we can't just update `pumpFrames`' `interval` parameter to be a clean 16 milliseconds by default, as that would break _other tests_.\r\n\r\nTo start with, the first paragraph in the [breaking changes process](https://github.com/flutter/flutter/wiki/Tree-hygiene#handling-breaking-changes) says:\r\n\r\n> Sometimes, however, doing this is necessary for the greater good. We want our APIs to be intuitive; if being backwards-compatible requires making an API into something that we would never have designed that way unless forced to by circumstances, then we should instead break the API and make it good.\r\n\r\nAdding a boolean to make the _correct_ behavior happen is not an API that we would have designed on purpose. It's also not a change that we can easily guide people to using, as there's no \"new API\" we can drive them towards with deprecations or data driven fixes. It'd be something we introduce for a period of time, hope people read the blog, then end up running into the same \"breaking change\" issues when we eventually remove the boolean or default it to true.\r\n\r\nFrom there, digging into the process, the preferred process is the three step process:\r\n\r\n1. Add new API and opt in to the new API\r\n2. Remove the old API\r\n3. Remove the opt in\r\n\r\nI think the only way we can get that to happen is to introduce a new version of `pumpFrames` that would support the correct behavior, deprecate the current `pumpFrames`, then eventually remove `pumpFrames`. Here's what I'd propose:\r\n\r\n* Fix `AutomatedTestWidgetsFlutterBinding` _without_ the flag\r\n* Introduce a new method with the exact contents that `pumpFrames` currently has:\r\n\r\n```\r\npumpFramesFor(\r\n  Widget target,\r\n  Duration duration, [\r\n    Duration interval = const Duration(milliseconds: 16, microseconds: 683),\r\n  ])\r\n```\r\n* Update `pumpFrames` to pass through to the new `pumpFramesFor` method:\r\n    * Check `if (binding is AutomatedTestWidgetsFlutterBinding)`\r\n    * If it is, then truncate the microseconds off of `interval` before passing through to maintain the current incorrect behavior\r\n\r\nMy biggest concern with this approach is that `pumpFramesFor` isn't as clean a name as just `pumpFrames`, but it's the best I can come up with. Names aside, introducing a new method and deprecating the old is the only way I can think of to keep the existing behavior and actually be able to drive users to the new api before landing the correct behavior.", "createdAt": "2022-10-14T17:25:00Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/113433#issuecomment-1279275788"}, {"id": "IC_kwDOAeUeuM5MRNUE", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "@pdblasi-google @CaseyHillers @goderbauer I agree with both sides of the opinion, both looks very reasonable to me. So just ping me when googlers reach a conclusion that what I should do!", "createdAt": "2022-10-14T23:13:36Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/113433#issuecomment-1279579396"}, {"id": "IC_kwDOAeUeuM5MY8tM", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "So... what should I do?", "createdAt": "2022-10-17T23:04:19Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/113433#issuecomment-1281608524"}, {"id": "IC_kwDOAeUeuM5MZC99", "author": {"login": "pdblasi-google"}, "authorAssociation": "CONTRIBUTOR", "body": "@fzyzcjy\r\n\r\nIf you're alright with it, I'd like to grab the issue from you to wrap it up. We'll need to make some changes internally and do some extra documentation to release this due to the internal test failures. If you'd like, I'll guide you through the extra docs and just handle the internal stuff myself, but I think it'll be easier with just one person working to get this landed.", "createdAt": "2022-10-17T23:41:19Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/113433#issuecomment-1281634173"}, {"id": "IC_kwDOAeUeuM5MZDHn", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "@pdblasi-google Sure :) so shall I close this issue now?", "createdAt": "2022-10-17T23:42:16Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/113433#issuecomment-1281634791"}, {"id": "IC_kwDOAeUeuM5MZDQR", "author": {"login": "pdblasi-google"}, "authorAssociation": "CONTRIBUTOR", "body": "This PR yes. I'll still work off of the original issue so we can keep the wonderful history of this surprisingly complex issue! \ud83d\ude1b ", "createdAt": "2022-10-17T23:43:11Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [{"content": "LAUGH", "users": {"totalCount": 1}}], "url": "https://github.com/flutter/flutter/pull/113433#issuecomment-1281635345"}, {"id": "IC_kwDOAeUeuM5MZDZI", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "@pdblasi-google Looking forward to see it landed!", "createdAt": "2022-10-17T23:44:15Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/113433#issuecomment-1281635912"}], "createdAt": "2022-10-14T11:46:19Z", "title": "Reland `AutomatedTestWidgetsFlutterBinding.pump` provides wrong pump time stamp, probably because of forgetting the precision, via optional flag"}}