{"source": "github", "metadata": {"org": "flutter", "repo": "flutter", "issue": 114124}, "content": {"author": {"login": "fzyzcjy"}, "body": "In https://github.com/flutter/flutter/pull/113998, I have fixed the bug caused by wrongly using engineLayer. But that bug is so time consuming to locate, so I write this PR to add assertions so we will not add such bugs in the future anymore.\r\n\r\n**Question**: In order to insert assertions, I have to wrap the `addToScene` function. IMHO the best thing is `addToScene` vs `performAddToScene` (like `layout` vs `performLayout` so everyone is familiar). However, that is a breaking change. I am not a googler so not sure whether you like it or not?\r\nIMHO the breaking change may be acceptable, because (1) it is merely a rename so simple to migrate (2) very few people write their own Layer class so this will affect few people.\r\n(Currently, I temporarily create a `addToSceneWrapped` method in order to see whether the code works - but I guess this should not be the final name)\r\n\r\nThis assertion does work, because https://github.com/flutter/flutter/pull/114124/checks?check_run_id=9132589021 reports the following error, which is exactly the error that #113998 finds and fixes.\r\n\r\n```\r\n\u2550\u2550\u2561 EXCEPTION CAUGHT BY SCHEDULER LIBRARY \u255e\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\nThe following assertion was thrown during a scheduler callback:\r\nWhen addToScene previously configures the engineLayer, it should either update it in current\r\naddToScene, or set it to null explicitly. Otherwise, Flutter framework may utilize that already\r\nout-of-date engineLayer and thus cause problems. However, it is observed that\r\npreviousEngineLayer=TransformEngineLayer#38532153 while engineLayer=TransformEngineLayer#38532153.\r\nThis originates in LeaderLayer#204442042.\r\n'package:flutter/src/rendering/layer.dart':\r\nFailed assertion: line 673 pos 9: 'previousEngineLayer == null || previousEngineLayer !=\r\nengineLayer'\r\n\r\nEither the assertion indicates an error in the framework itself, or we should provide substantially\r\nmore information in this error message to help you determine and fix the underlying cause.\r\nIn either case, please report this assertion by filing a bug on GitHub:\r\n  https://github.com/flutter/flutter/issues/new?template=2_bug.md\r\n\r\nWhen the exception was thrown, this was the stack:\r\n#2      Layer.addToSceneWrapped.<anonymous closure> (package:flutter/src/rendering/layer.dart:673:9)\r\n#3      Layer.addToSceneWrapped (package:flutter/src/rendering/layer.dart:683:6)\r\n#4      Layer._addToSceneWithRetainedRendering (package:flutter/src/rendering/layer.dart:701:5)\r\n#5      ContainerLayer.addChildrenToScene (package:flutter/src/rendering/layer.dart:1311:13)\r\n#6      OffsetLayer.addToScene (package:flutter/src/rendering/layer.dart:1448:5)\r\n#7      Layer.addToSceneWrapped (package:flutter/src/rendering/layer.dart:669:5)\r\n#8      Layer._addToSceneWithRetainedRendering (package:flutter/src/rendering/layer.dart:701:5)\r\n#9      ContainerLayer.addChildrenToScene (package:flutter/src/rendering/layer.dart:1311:13)\r\n#10     OffsetLayer.addToScene (package:flutter/src/rendering/layer.dart:1448:5)\r\n#11     Layer.addToSceneWrapped (package:flutter/src/rendering/layer.dart:669:5)\r\n#12     Layer._addToSceneWithRetainedRendering (package:flutter/src/rendering/layer.dart:701:5)\r\n#13     ContainerLayer.addChildrenToScene (package:flutter/src/rendering/layer.dart:1311:13)\r\n#14     TransformLayer.addToScene (package:flutter/src/rendering/layer.dart:1941:5)\r\n#15     Layer.addToSceneWrapped (package:flutter/src/rendering/layer.dart:669:5)\r\n#16     ContainerLayer.buildScene (package:flutter/src/rendering/layer.dart:1124:5)\r\n#17     RenderView.compositeFrame (package:flutter/src/rendering/view.dart:231:37)\r\n#18     AutomatedTestWidgetsFlutterBinding.drawFrame (package:flutter_test/src/binding.dart:1257:26)\r\n#19     RendererBinding._handlePersistentFrameCallback (package:flutter/src/rendering/binding.dart:375:5)\r\n#20     SchedulerBinding._invokeFrameCallback (package:flutter/src/scheduler/binding.dart:1275:15)\r\n#21     SchedulerBinding.handleDrawFrame (package:flutter/src/scheduler/binding.dart:1204:9)\r\n#22     AutomatedTestWidgetsFlutterBinding.pump.<anonymous closure> (package:flutter_test/src/binding.dart:1096:9)\r\n#25     TestAsyncUtils.guard (package:flutter_test/src/test_async_utils.dart:71:41)\r\n#26     AutomatedTestWidgetsFlutterBinding.pump (package:flutter_test/src/binding.dart:1082:27)\r\n#27     WidgetTester.pump.<anonymous closure> (package:flutter_test/src/widget_tester.dart:618:53)\r\n#30     TestAsyncUtils.guard (package:flutter_test/src/test_async_utils.dart:71:41)\r\n#31     WidgetTester.pump (package:flutter_test/src/widget_tester.dart:618:27)\r\n#32     main.<anonymous closure> (file:///b/s/w/ir/x/w/flutter/packages/flutter/test/widgets/autocomplete_test.dart:491:18)\r\n<asynchronous suspension>\r\n<asynchronous suspension>\r\n(elided 7 frames from class _AssertionError, dart:async, and package:stack_trace)\r\n\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n```\r\n\r\n## Pre-launch Checklist\r\n\r\n- [x] I read the [Contributor Guide] and followed the process outlined there for submitting PRs.\r\n- [x] I read the [Tree Hygiene] wiki page, which explains my responsibilities.\r\n- [x] I read and followed the [Flutter Style Guide], including [Features we expect every widget to implement].\r\n- [x] I signed the [CLA].\r\n- [x] I listed at least one issue that this PR fixes in the description above.\r\n- [x] I updated/added relevant documentation (doc comments with `///`).\r\n- [ ] I added new tests to check the change I am making, or this PR is [test-exempt].\r\n- [x] All existing and new tests are passing.\r\n\r\nIf you need help, consider asking for advice on the #hackers-new channel on [Discord].\r\n\r\n<!-- Links -->\r\n[Contributor Guide]: https://github.com/flutter/flutter/wiki/Tree-hygiene#overview\r\n[Tree Hygiene]: https://github.com/flutter/flutter/wiki/Tree-hygiene\r\n[test-exempt]: https://github.com/flutter/flutter/wiki/Tree-hygiene#tests\r\n[Flutter Style Guide]: https://github.com/flutter/flutter/wiki/Style-guide-for-Flutter-repo\r\n[Features we expect every widget to implement]: https://github.com/flutter/flutter/wiki/Style-guide-for-Flutter-repo#features-we-expect-every-widget-to-implement\r\n[CLA]: https://cla.developers.google.com/\r\n[flutter/tests]: https://github.com/flutter/tests\r\n[breaking change policy]: https://github.com/flutter/flutter/wiki/Tree-hygiene#handling-breaking-changes\r\n[Discord]: https://github.com/flutter/flutter/wiki/Chat\r\n", "comments": [{"id": "IC_kwDOAeUeuM5Oi7oJ", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "Have no bandwidth now, will reply to review soon, thanks :)", "createdAt": "2022-11-16T22:50:39Z", "includesCreatedEdit": true, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/114124#issuecomment-1317779977"}], "createdAt": "2022-10-27T03:06:12Z", "title": "Avoid future bugs about wrong manipulation of engineLayer inside addToScene"}}