{"source": "github", "metadata": {"org": "flutter", "repo": "flutter", "issue": 114400}, "content": {"author": {"login": "fzyzcjy"}, "body": "Close https://github.com/flutter/flutter/issues/114398\r\n\r\n### Problem description\r\n\r\nIn short, the SnapshotWidget is rendered differently when enabled vs disabled.\r\n\r\nReproduction:\r\n\r\n<details>\r\n\r\n```dart\r\nimport 'dart:ui' as ui;\r\n\r\nimport 'package:flutter/material.dart';\r\nimport 'package:flutter/rendering.dart';\r\nimport 'package:flutter_test/flutter_test.dart';\r\n\r\nvoid main() {\r\n  final binding = TestWidgetsFlutterBinding.ensureInitialized();\r\n  testWidgets('SnapshotWidget should have same result when enabled', (tester) async {\r\n    binding.window\r\n      ..physicalSizeTestValue = const Size(10, 10)\r\n      ..devicePixelRatioTestValue = 1;\r\n    addTearDown(() => binding.window\r\n      ..clearPhysicalSizeTestValue()\r\n      ..clearDevicePixelRatioTestValue());\r\n\r\n    final controller = SnapshotController(allowSnapshotting: false);\r\n    await tester.pumpWidget(MaterialApp(\r\n      debugShowCheckedModeBanner: false,\r\n      home: Container(\r\n        color: Colors.black,\r\n        padding: const EdgeInsets.only(right: 0.6, bottom: 0.6),\r\n        child: SnapshotWidget(\r\n          controller: controller,\r\n          child: Container(\r\n            margin: const EdgeInsets.only(right: 0.4, bottom: 0.4),\r\n            color: Colors.blue,\r\n          ),\r\n        ),\r\n      ),\r\n    ));\r\n\r\n    final imageWhenDisabled = await _captureImage(tester.element(find.byType(MaterialApp)));\r\n\r\n    controller.allowSnapshotting = true;\r\n    await tester.pump();\r\n\r\n    final imageWhenEnabled = await _captureImage(tester.element(find.byType(MaterialApp)));\r\n    await expectLater(imageWhenEnabled, matchesReferenceImage(imageWhenDisabled));\r\n  });\r\n}\r\n\r\nFuture<ui.Image> _captureImage(Element element) {\r\n  assert(element.renderObject != null);\r\n  RenderObject renderObject = element.renderObject!;\r\n  while (!renderObject.isRepaintBoundary) {\r\n    renderObject = renderObject.parent! as RenderObject;\r\n  }\r\n  assert(!renderObject.debugNeedsPaint);\r\n  final OffsetLayer layer = renderObject.debugLayer! as OffsetLayer;\r\n  return layer.toImage(renderObject.paintBounds);\r\n}\r\n```\r\n\r\n</details>\r\n\r\nIf you dump the images, will see:\r\n\r\nimageWhenDisabled\r\n![image](https://user-images.githubusercontent.com/5236035/199182280-2001019b-0b3c-452a-99fa-42d42c60dcf8.png)\r\n\r\nimageWhenEnabled\r\n![image](https://user-images.githubusercontent.com/5236035/199182308-d4c65422-085a-4e86-b849-55043bd4d481.png)\r\n\r\n### How PR solves it\r\n\r\nIt seems that this is caused by integer rounding. For example, suppose our SnapshotWidget (and thus its Layer) is 9.4 pixels, then after toImageSync will get a 10x10 (or 9x9?) ui.Image instead of a 9.4x9.4 image - since image size must be integer. Then, next time we paint this ui.Image, the original code will paint the 10x10 rectangle area into the 9.4x9.4 Canvas, thus causing resizing of the content. The PR will remember the real size is 9.4 instead of 10, so next time when painting the ui.Image we will paint the 9.4x9.4 rectangle area into the 9.4x9.4 canvas, so no resize of content.\r\n\r\n## Pre-launch Checklist\r\n\r\n- [x] I read the [Contributor Guide] and followed the process outlined there for submitting PRs.\r\n- [x] I read the [Tree Hygiene] wiki page, which explains my responsibilities.\r\n- [x] I read and followed the [Flutter Style Guide], including [Features we expect every widget to implement].\r\n- [x] I signed the [CLA].\r\n- [x] I listed at least one issue that this PR fixes in the description above.\r\n- [x] I updated/added relevant documentation (doc comments with `///`).\r\n- [x] I added new tests to check the change I am making, or this PR is [test-exempt].\r\n- [ ] All existing and new tests are passing.\r\n\r\nIf you need help, consider asking for advice on the #hackers-new channel on [Discord].\r\n\r\n<!-- Links -->\r\n[Contributor Guide]: https://github.com/flutter/flutter/wiki/Tree-hygiene#overview\r\n[Tree Hygiene]: https://github.com/flutter/flutter/wiki/Tree-hygiene\r\n[test-exempt]: https://github.com/flutter/flutter/wiki/Tree-hygiene#tests\r\n[Flutter Style Guide]: https://github.com/flutter/flutter/wiki/Style-guide-for-Flutter-repo\r\n[Features we expect every widget to implement]: https://github.com/flutter/flutter/wiki/Style-guide-for-Flutter-repo#features-we-expect-every-widget-to-implement\r\n[CLA]: https://cla.developers.google.com/\r\n[flutter/tests]: https://github.com/flutter/tests\r\n[breaking change policy]: https://github.com/flutter/flutter/wiki/Tree-hygiene#handling-breaking-changes\r\n[Discord]: https://github.com/flutter/flutter/wiki/Chat\r\n", "comments": [{"id": "IC_kwDOAeUeuM5NcqzO", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "@jonahwilliams done", "createdAt": "2022-11-01T23:40:38Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/114400#issuecomment-1299360974"}, {"id": "IC_kwDOAeUeuM5Nct-r", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "You are welcome!\r\n\r\n(I will update code soon)", "createdAt": "2022-11-02T00:02:37Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/114400#issuecomment-1299373995"}, {"id": "IC_kwDOAeUeuM5NdMQt", "author": {"login": "jonahwilliams"}, "authorAssociation": "MEMBER", "body": "FYI @dnfield / @goderbauer as secondary review", "createdAt": "2022-11-02T03:00:23Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [{"content": "LAUGH", "users": {"totalCount": 1}}], "url": "https://github.com/flutter/flutter/pull/114400#issuecomment-1299498029"}, {"id": "IC_kwDOAeUeuM5OWfo_", "author": {"login": "auto-submit"}, "authorAssociation": "NONE", "body": "auto label is removed for flutter/flutter, pr: 114400, due to - The status or check suite [Mac tool_tests_commands](https://ci.chromium.org/b/8797480605381409169) has failed. Please fix the issues identified (or deflake) before re-applying this label.\n", "createdAt": "2022-11-14T23:03:06Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/114400#issuecomment-1314519615"}, {"id": "IC_kwDOAeUeuM5OWgAM", "author": {"login": "jonahwilliams"}, "authorAssociation": "MEMBER", "body": "@fzyzcjy could you update to ToT so we can land this?", "createdAt": "2022-11-14T23:04:40Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/114400#issuecomment-1314521100"}, {"id": "IC_kwDOAeUeuM5OWk1X", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "@jonahwilliams sure, done (waiting for ci now)", "createdAt": "2022-11-14T23:25:04Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [{"content": "THUMBS_UP", "users": {"totalCount": 1}}], "url": "https://github.com/flutter/flutter/pull/114400#issuecomment-1314540887"}], "createdAt": "2022-11-01T07:39:12Z", "title": "Incorrect rendering of `SnapshotWidget`"}}