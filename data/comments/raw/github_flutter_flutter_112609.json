{"source": "github", "metadata": {"org": "flutter", "repo": "flutter", "issue": 112609}, "content": {"author": {"login": "fzyzcjy"}, "body": "The fix is just one line:\r\n\r\n![image](https://user-images.githubusercontent.com/5236035/192926480-dc287d01-62bb-4dc8-9c16-f62f6d03b0da.png)\r\n\r\nI have `git blame` and find the bug exist since the first version 7yr ago, and no special comments about why this is introduced so I guess it is but not feature.\r\n\r\nIMHO the bug may be written like, the programmer wants to convert DateTime (the `clock.now()`) into a Duration. But then it is forgotten that both are microseconds precision instead of milliseconds precision, and the milliseconds approach is used.\r\n\r\n*List which issues are fixed by this PR. You must list at least one issue.*\r\nClose #112610\r\n\r\n*If you had to change anything in the [flutter/tests] repo, include a link to the migration guide as per the [breaking change policy].*\r\n\r\n## Pre-launch Checklist\r\n\r\n- [x] I read the [Contributor Guide] and followed the process outlined there for submitting PRs.\r\n- [x] I read the [Tree Hygiene] wiki page, which explains my responsibilities.\r\n- [x] I read and followed the [Flutter Style Guide], including [Features we expect every widget to implement].\r\n- [x] I signed the [CLA].\r\n- [x] I listed at least one issue that this PR fixes in the description above.\r\n- [x] I updated/added relevant documentation (doc comments with `///`).\r\n- [x] I added new tests to check the change I am making, or this PR is [test-exempt].\r\n- [x] All existing and new tests are passing.\r\n\r\nIf you need help, consider asking for advice on the #hackers-new channel on [Discord].\r\n\r\n<!-- Links -->\r\n[Contributor Guide]: https://github.com/flutter/flutter/wiki/Tree-hygiene#overview\r\n[Tree Hygiene]: https://github.com/flutter/flutter/wiki/Tree-hygiene\r\n[test-exempt]: https://github.com/flutter/flutter/wiki/Tree-hygiene#tests\r\n[Flutter Style Guide]: https://github.com/flutter/flutter/wiki/Style-guide-for-Flutter-repo\r\n[Features we expect every widget to implement]: https://github.com/flutter/flutter/wiki/Style-guide-for-Flutter-repo#features-we-expect-every-widget-to-implement\r\n[CLA]: https://cla.developers.google.com/\r\n[flutter/tests]: https://github.com/flutter/tests\r\n[breaking change policy]: https://github.com/flutter/flutter/wiki/Tree-hygiene#handling-breaking-changes\r\n[Discord]: https://github.com/flutter/flutter/wiki/Chat\r\n\r\n---\r\n\r\np.s. test fails with old code, confirming that the test is effective.\r\n\r\n![image](https://user-images.githubusercontent.com/5236035/192926239-e83874e6-6dc0-4265-a4d5-dda0c9018bf8.png)\r\n![image](https://user-images.githubusercontent.com/5236035/192926266-e202747f-9e1a-49a2-abf2-a9624bd2c03d.png)\r\n", "comments": [{"id": "IC_kwDOAeUeuM5LpX1O", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "```\r\n| 00:15 +36: /b/s/w/ir/x/t/flutter_customer_testing.flutter_packages.RNUBSQ/tests/packages/animations/test/open_container_test.dart: Container closes - Fade (by default)\r\n| \u2550\u2550\u2561 EXCEPTION CAUGHT BY FLUTTER TEST FRAMEWORK \u255e\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n| The following TestFailure was thrown running a test:\r\n| Expected: 1.0 (\u00b11e-10)\r\n|   Actual: <0.9999833333333332>\r\n|    Which: 0.9999833333333332 is not in the range of 1.0 (\u00b11e-10).\r\n|\r\n| When the exception was thrown, this was the stack:\r\n| #4      main.<anonymous closure> (file:///b/s/w/ir/x/t/flutter_customer_testing.flutter_packages.RNUBSQ/tests/packages/animations/test/open_container_test.dart:273:7)\r\n| <asynchronous suspension>\r\n| <asynchronous suspension>\r\n| (elided one frame from package:stack_trace)\r\n|\r\n| This was caught by the test expectation on the following line:\r\n|   file:///b/s/w/ir/x/t/flutter_customer_testing.flutter_packages.RNUBSQ/tests/packages/animations/test/open_container_test.dart line 273\r\n| The test description was:\r\n|   Container closes - Fade (by default)\r\n| \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n|\r\n| 00:15 +37 -1: /b/s/w/ir/x/t/flutter_customer_testing.flutter_packages.RNUBSQ/tests/packages/animations/test/fade_scale_transition_test.dart: FadeScaleTransitionConfiguration builds a new route\r\n| 00:15 +37 -1: /b/s/w/ir/x/t/flutter_customer_testing.flutter_packages.RNUBSQ/tests/packages/animations/test/open_container_test.dart: Container closes - Fade (by default) [E]\r\n|   Test failed. See exception logs above.\r\n|   The test description was: Container closes - Fade (by default)\r\n```", "createdAt": "2022-10-06T00:16:57Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/112609#issuecomment-1269136718"}, {"id": "IC_kwDOAeUeuM5LpX8F", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "@pdblasi-google I guess maybe need to update the custom testing configurations to point to the latest tests?", "createdAt": "2022-10-06T00:17:28Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/112609#issuecomment-1269137157"}, {"id": "IC_kwDOAeUeuM5Luk9M", "author": {"login": "pdblasi-google"}, "authorAssociation": "CONTRIBUTOR", "body": "@fzyzcjy Yup, you called it. Apologies, I forgot to point the flutter/tests repo to the latest tests. PR is up for that now, I'll ping here when it goes through.", "createdAt": "2022-10-06T18:20:51Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/112609#issuecomment-1270501196"}, {"id": "IC_kwDOAeUeuM5LvL4m", "author": {"login": "flutter-dashboard"}, "authorAssociation": "NONE", "body": "Golden file changes have been found for this pull request. Click [here to view and triage](https://flutter-gold.skia.org/cl/github/112609) (e.g. because this is an intentional change).\n\nIf you are still iterating on this change and are not ready to resolve the images on the Flutter Gold dashboard, consider marking this PR as a draft pull request above. You will still be able to view image results on the dashboard, commenting will be silenced, and the check will not try to resolve itself until marked ready for review.\n\n\n\nFor more guidance, visit [Writing a golden file test for `package:flutter`](https://github.com/flutter/flutter/wiki/Writing-a-golden-file-test-for-package:flutter).\n\n__Reviewers__: Read the [Tree Hygiene page](https://github.com/flutter/flutter/wiki/Tree-hygiene#how-to-review-code) and make sure this patch meets those guidelines before LGTMing.\n\n_Changes reported for pull request #112609 at sha 02ebd54c3343d0c3aaabcba423b5db13b2bfaadb_\n\n", "createdAt": "2022-10-06T20:44:21Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/112609#issuecomment-1270660646"}, {"id": "IC_kwDOAeUeuM5Lv2y8", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "Thanks and \ud83c\udf89 !", "createdAt": "2022-10-06T23:22:52Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/112609#issuecomment-1270836412"}, {"id": "IC_kwDOAeUeuM5MMkY-", "author": {"login": "CaseyHillers"}, "authorAssociation": "CONTRIBUTOR", "body": "@fzyzcjy @goderbauer this is a breaking change. Can a migration guide be written on how developers can migrate their code with this change? I'm not sure what's needed on my end as a developer, and my animation tests are now very flaky.", "createdAt": "2022-10-14T01:40:05Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/112609#issuecomment-1278363198"}, {"id": "IC_kwDOAeUeuM5MMk0_", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "@CaseyHillers Hi,\r\n\r\n> Can a migration guide be written on how developers can migrate their code with this change? ...and my animation tests are now very flaky.\r\n\r\nCould you please share some flaky test minimal reproducible samples? IMHO this should not make any problem so want to see reproductions in order to know what happens", "createdAt": "2022-10-14T01:44:06Z", "includesCreatedEdit": true, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/112609#issuecomment-1278364991"}, {"id": "IC_kwDOAeUeuM5MMmUx", "author": {"login": "CaseyHillers"}, "authorAssociation": "CONTRIBUTOR", "body": "Here's an example now that is flaky:\r\n\r\n```dart\r\n      await tester.pumpWidget(myAnimatedWidget);\r\n      await tester.pumpAndSettle();\r\n\r\n      await tester.sendSelectEvent();\r\n\r\n      await tester.pumpFrames(scene, Duration(milliseconds: 100));\r\n      await expectLater(\r\n          find.byType(MyAnimatedWidget),\r\n          matchesGoldenFile(\r\n              'animated_widget'));\r\n```\r\n\r\nThe resulting goldens are changing. When I change `pumpFrames` to microseconds, I am still seeing the same flakiness. I'm unsure if it's because the earlier clocks are still in millisecond mode.", "createdAt": "2022-10-14T01:57:31Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/112609#issuecomment-1278371121"}, {"id": "IC_kwDOAeUeuM5MMmr1", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "@CaseyHillers Weird. Some possible ideas:\r\n\r\n1. Do you have anything that depends on e.g. a real clock? If so, it will be flaky. (I guess no)\r\n2. Could you please change `MyAnimatedWidget` to something like `AnimatedBuilder(builder: (_, value) => Text('the value is: $value')`. Then, when the golden is changing, we can know what value indeed it is having.\r\n\r\n> I'm unsure if it's because the earlier clocks are still in millisecond mode.\r\n\r\nDo you mean the new golden (i.e. after the PR) are different from old golden, and the new golden is itself stable? If so, looks like it is possible. Indeed the animation controller is fed with a changed animation time.", "createdAt": "2022-10-14T02:00:52Z", "includesCreatedEdit": true, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/112609#issuecomment-1278372597"}, {"id": "IC_kwDOAeUeuM5MMpsb", "author": {"login": "CaseyHillers"}, "authorAssociation": "CONTRIBUTOR", "body": "My animated widgets are just an animated builder that has a custom animation controller. @goderbauer or @pdblasi-google can help with reproducing the issue here.\r\n\r\nMy understanding is I need to change every possible clock to be in microseconds instead of milliseconds. This seems to be a breaking change for any other customers, and I'm having a difficult time tracking all the various clocks in my codebase.\r\n\r\nI haven't found the discord threads, but I wonder if this is something that should be in the framework. There could be a tester field added for high precision or this can be added directly to your package. I assume most Flutter tests aren't needing high precision, and this is going to cause a lot of pain once it's in beta/stable.", "createdAt": "2022-10-14T02:22:06Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/112609#issuecomment-1278384923"}, {"id": "IC_kwDOAeUeuM5MMqAg", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "@CaseyHillers \r\n\r\n> I need to change every possible clock to be in microseconds instead of milliseconds\r\n\r\nBtw I am curious why a clock can in milliseconds in codebase - `clock` package, `Duration`, DateTime, etc are all in microseconds.\r\n\r\n> I haven't found the discord threads, but I wonder if this is something that should be in the framework. There could be a tester field added for high precision or this can be added directly to your package. I assume most Flutter tests aren't needing high precision, and this is going to cause a lot of pain once it's in beta/stable.\r\n\r\nI agree that an alternative solution is to use a bool flag to enable high-accuracy (I have done that indeed - https://github.com/flutter/flutter/pull/112609/commits/e0b5882b87bc8fe025d55d626ec663c8587522b7).", "createdAt": "2022-10-14T02:24:29Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/112609#issuecomment-1278386208"}, {"id": "IC_kwDOAeUeuM5MOk2t", "author": {"login": "CaseyHillers"}, "authorAssociation": "CONTRIBUTOR", "body": "> I agree that an alternative solution is to use a bool flag to enable high-accuracy (I have done that indeed - https://github.com/flutter/flutter/commit/e0b5882b87bc8fe025d55d626ec663c8587522b7).\r\n\r\nThanks, that sounds like it would work for me! Are there plans to upstream that change?", "createdAt": "2022-10-14T11:38:10Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/112609#issuecomment-1278889389"}, {"id": "IC_kwDOAeUeuM5MOlHr", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "@CaseyHillers I am ok with that, just not sure what other reviewers think? (Since that was my original design and later a reviewer suggests me to change to what is current merged.) If you guys are OK I will PR it.", "createdAt": "2022-10-14T11:39:13Z", "includesCreatedEdit": true, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/112609#issuecomment-1278890475"}, {"id": "IC_kwDOAeUeuM5MOnFw", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "@CaseyHillers Here is the PR: https://github.com/flutter/flutter/pull/113433", "createdAt": "2022-10-14T11:48:14Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/112609#issuecomment-1278898544"}], "createdAt": "2022-09-29T02:44:43Z", "title": "`AutomatedTestWidgetsFlutterBinding.pump` provides wrong pump time stamp, probably because of forgetting the precision"}}