{"source": "github", "metadata": {"org": "flutter", "repo": "engine", "issue": 36911}, "content": {"author": {"login": "fzyzcjy"}, "body": "1. I will finish code details, refine code, add tests, make tests pass, etc, after a code review that thinks the *rough idea* is acceptable. It is because, from my past experience, reviews may request changing a lot. If the general idea is to be changed, all detailed implementation efforts are wasted :)\r\n2. The PR has an already-working counterpart, and it produces ~60FPS smooth experimental results. The benchmark results and detailed analysis is in chapter https://cjycode.com/flutter_smooth/benchmark/. All the source code is in  https://github.com/fzyzcjy/engine/tree/flutter-smooth and https://github.com/fzyzcjy/flutter/tree/flutter-smooth.\r\n3. Possibly useful as a context to this PR, there is a whole chapter discussing the internals - how flutter_smooth is implemented. (Link: https://cjycode.com/flutter_smooth/design/)\r\n\r\n---\r\n\r\n\r\n*This fixes the jank happened in **classical** Flutter, even without the existence of flutter_smooth*\r\n\r\n*I will add tests and refine code etc after some code review - since review may request changing the code :)*\r\n\r\n*This works pretty well in flutter_smooth, see https://github.com/fzyzcjy/engine/blob/flutter-smooth/shell/common/animator.cc for full code.*\r\n\r\nDuring experiments, I observe a phenomenon: Even when the UI thread finishes everything *before* the deadline (vsync) a few milliseconds, the next frame is scheduled *one* vsync later, causing one jank. For example, UI thread may run from 0-15ms, but the next frame starts from 33.33ms instead of the correct 16.67ms.\r\n\r\nAn example screenshot can be seen at the end of this proposal. I added a timeline event, `Animator::AwaitVSync`, so we can clearly see when vsync await is called. (This screenshot has roughly 3ms space; but more frequently, I see this bug when there is about 0.5-2ms space.)\r\n\r\nTherefore, this PR tries to fix this problem. The main idea is that, when detecting we are very near the next vsync, we do not wait at all, but instead directly start the next frame.\r\n\r\n![image](https://user-images.githubusercontent.com/5236035/197105732-7c0bfbad-8816-46c0-85b1-5007d0f82d5d.png)\r\n\r\nzoom in:\r\n\r\n![image](https://user-images.githubusercontent.com/5236035/197105742-c511137c-3089-4ff9-b102-52bdfcfc72f9.png)\r\n\r\nfurther zoom in:\r\n\r\n![image](https://user-images.githubusercontent.com/5236035/197105754-fd471b8f-1ae7-45cb-b4d8-3163beb0d87a.png)\r\n\r\n## Pre-launch Checklist\r\n\r\n- [x] I read the [Contributor Guide] and followed the process outlined there for submitting PRs.\r\n- [x] I read the [Tree Hygiene] wiki page, which explains my responsibilities.\r\n- [x] I read and followed the [Flutter Style Guide] and the [C++, Objective-C, Java style guides].\r\n- [x] I listed at least one issue that this PR fixes in the description above.\r\n- [x] I added new tests to check the change I am making or feature I am adding, or Hixie said the PR is test-exempt. See [testing the engine] for instructions on\r\nwriting and running engine tests. -- see above\r\n- [x] I updated/added relevant documentation (doc comments with `///`).\r\n- [x] I signed the [CLA].\r\n- [ ] All existing and new tests are passing.\r\n\r\nIf you need help, consider asking for advice on the #hackers-new channel on [Discord].\r\n\r\n<!-- Links -->\r\n[Contributor Guide]: https://github.com/flutter/flutter/wiki/Tree-hygiene#overview\r\n[Tree Hygiene]: https://github.com/flutter/flutter/wiki/Tree-hygiene\r\n[Flutter Style Guide]: https://github.com/flutter/flutter/wiki/Style-guide-for-Flutter-repo\r\n[C++, Objective-C, Java style guides]: https://github.com/flutter/engine/blob/main/CONTRIBUTING.md#style\r\n[testing the engine]: https://github.com/flutter/flutter/wiki/Testing-the-engine\r\n[CLA]: https://cla.developers.google.com/\r\n[flutter/tests]: https://github.com/flutter/tests\r\n[breaking change policy]: https://github.com/flutter/flutter/wiki/Tree-hygiene#handling-breaking-changes\r\n[Discord]: https://github.com/flutter/flutter/wiki/Chat\r\n", "comments": [{"id": "IC_kwDOAlZRSc5MrSrR", "author": {"login": "flutter-dashboard"}, "authorAssociation": "NONE", "body": "It looks like this pull request may not have tests. Please make sure to add tests before merging. If you need [an exemption](https://github.com/flutter/flutter/wiki/Tree-hygiene#tests) to this rule, contact Hixie on the #hackers channel in [Chat](https://github.com/flutter/flutter/wiki/Chat) (don't just cc him here, he won't see it! *He's on Discord!*).\n\nIf you are not sure if you need tests, consider this rule of thumb: the purpose of a test is to make sure someone doesn't accidentally revert the fix. Ask yourself, **is there anything in your PR that you feel it is important we not accidentally revert back to how it was before your fix?**\n\n__Reviewers__: Read the [Tree Hygiene page](https://github.com/flutter/flutter/wiki/Tree-hygiene#how-to-review-code) and make sure this patch meets those guidelines before LGTMing.", "createdAt": "2022-10-21T03:39:52Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/engine/pull/36911#issuecomment-1286417105"}, {"id": "IC_kwDOAlZRSc5NIj7t", "author": {"login": "dnfield"}, "authorAssociation": "MEMBER", "body": "This seems very similar to https://github.com/flutter/engine/pull/29276\r\n\r\nSimilar concerns as to that one: we need some motivating benchmarks that clearly show what benefits would be gained here, and we need to see that changes to this won't negatively impact existing benchmarks/users.", "createdAt": "2022-10-27T21:35:52Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/engine/pull/36911#issuecomment-1294089965"}, {"id": "IC_kwDOAlZRSc5NJD0p", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "Thanks for pointing out the related PR.\r\n\r\n> Similar concerns as to that one: we need some motivating benchmarks that clearly show what benefits would be gained here, and we need to see that changes to this won't negatively impact existing benchmarks/users.\r\n\r\nSure. I will try to make one.\r\n\r\n> we need to see that changes to this won't negatively impact existing benchmarks/users.\r\n\r\nMay I know how to do this? does not see benchmark data on CI IMHO", "createdAt": "2022-10-27T23:12:04Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/engine/pull/36911#issuecomment-1294220585"}, {"id": "IC_kwDOAlZRSc5NJD9R", "author": {"login": "dnfield"}, "authorAssociation": "MEMBER", "body": "flutter-flutter-perf.skia.org and flutter-engine-perf.skia.org has benchmark data", "createdAt": "2022-10-27T23:13:08Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/engine/pull/36911#issuecomment-1294221137"}, {"id": "IC_kwDOAlZRSc5NJEqf", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "@dnfield Thanks, may I know some doc, or how to see perf benchmark of a PR? Click \"help\" gives http://go/perf-user-doc which cannot be opened (google internal only?)", "createdAt": "2022-10-27T23:18:08Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/engine/pull/36911#issuecomment-1294224031"}, {"id": "IC_kwDOAlZRSc5Nv1no", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "@dnfield \r\n\r\n(content of this comment is moved to: https://github.com/flutter/engine/pull/37341)", "createdAt": "2022-11-05T03:00:01Z", "includesCreatedEdit": true, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/engine/pull/36911#issuecomment-1304386024"}, {"id": "IC_kwDOAlZRSc5Nv10Z", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "(content is also moved to #37341)\r\n\r\n<details>\r\n\r\n> @dnfield and we need to see that changes to this won't negatively impact existing benchmarks/users\r\n\r\nCould you please give some hints? I guess I have no permission to execute skia perf as it seems only run on master or other flutter branches. Thus, maybe I can do nothing except for creating a PR and see skia perf after it is merged...\r\n\r\n</details>", "createdAt": "2022-11-05T03:04:13Z", "includesCreatedEdit": true, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/engine/pull/36911#issuecomment-1304386841"}], "createdAt": "2022-10-21T03:39:49Z", "title": "Fix janks caused by await vsync in classical Flutter"}}