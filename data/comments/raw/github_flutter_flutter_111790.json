{"source": "github", "metadata": {"org": "flutter", "repo": "flutter", "issue": 111790}, "content": {"author": {"login": "fzyzcjy"}, "body": "### How the bug is found\r\n\r\nThis bug is surely not found by human eyes reading each and every line of Flutter code :)\r\n\r\nI proposed the idea that a linter can be created (https://github.com/dart-code-checker/dart-code-metrics/issues/997) to validate whether RenderObject field setters have correct early-return code. @incendial implemented it and ran it (https://github.com/dart-code-checker/dart-code-metrics/pull/1003).\r\n\r\nThus, thanks @incendial for implementing the linter and run it through flutter framework code!\r\n\r\n### Bug description\r\n\r\nAs we know, when implementing a setter in RenderObject, we usually early halt if the new value is equal to the old value (such as [this one](https://github.com/flutter/flutter/blob/7fba37848c9f3007795be2d67a3207067b7a0894/packages/flutter/lib/src/rendering/platform_view.dart#L115), indeed almost all fields in RenderObject child classes are examples). This is very necessary, because we are setting fields in `updateRenderObject` *unconditionally*. If we do not early return, we will execute the full logic like markNeedsPaint and so on *unconditionally* on *every* `updateRenderObject`. That will be performance penalty.\r\n\r\nThe current PR fixes one bug of such case. In more details, the `viewController` field setter lacks such early-return, and thus unconditionally calls markNeedsPaint. The setter is called from `updateRenderObject` as follows:\r\n\r\n![image](https://user-images.githubusercontent.com/5236035/190656619-8aae1809-81f7-475e-8786-73b260c6d3b5.png)\r\n\r\nAnd _UiKitPlatformView is used here:\r\n\r\n![image](https://user-images.githubusercontent.com/5236035/190656716-04152bb1-d791-4b0a-8b6a-31f72479ae02.png)\r\n\r\nIn other words, the controller is not changed in every frame. Instead, in common cases, it should be the same one for many frames. However, it triggers repaint for each and every rebuild.\r\n\r\nClose #111788 \r\n\r\n*If you had to change anything in the [flutter/tests] repo, include a link to the migration guide as per the [breaking change policy].*\r\n\r\n## Pre-launch Checklist\r\n\r\n- [x] I read the [Contributor Guide] and followed the process outlined there for submitting PRs.\r\n- [x] I read the [Tree Hygiene] wiki page, which explains my responsibilities.\r\n- [x] I read and followed the [Flutter Style Guide], including [Features we expect every widget to implement].\r\n- [x] I signed the [CLA].\r\n- [x] I listed at least one issue that this PR fixes in the description above.\r\n- [x] I updated/added relevant documentation (doc comments with `///`).\r\n- [x] I added new tests to check the change I am making, or this PR is [test-exempt].\r\n- [ ] All existing and new tests are passing.\r\n\r\nIf you need help, consider asking for advice on the #hackers-new channel on [Discord].\r\n\r\n<!-- Links -->\r\n[Contributor Guide]: https://github.com/flutter/flutter/wiki/Tree-hygiene#overview\r\n[Tree Hygiene]: https://github.com/flutter/flutter/wiki/Tree-hygiene\r\n[test-exempt]: https://github.com/flutter/flutter/wiki/Tree-hygiene#tests\r\n[Flutter Style Guide]: https://github.com/flutter/flutter/wiki/Style-guide-for-Flutter-repo\r\n[Features we expect every widget to implement]: https://github.com/flutter/flutter/wiki/Style-guide-for-Flutter-repo#features-we-expect-every-widget-to-implement\r\n[CLA]: https://cla.developers.google.com/\r\n[flutter/tests]: https://github.com/flutter/tests\r\n[breaking change policy]: https://github.com/flutter/flutter/wiki/Tree-hygiene#handling-breaking-changes\r\n[Discord]: https://github.com/flutter/flutter/wiki/Chat\r\n", "comments": [{"id": "IC_kwDOAeUeuM5KgHez", "author": {"login": "flutter-dashboard"}, "authorAssociation": "NONE", "body": "It looks like this pull request may not have tests. Please make sure to add tests before merging. If you need [an exemption](https://github.com/flutter/flutter/wiki/Tree-hygiene#tests) to this rule, contact Hixie on the #hackers channel in [Chat](https://github.com/flutter/flutter/wiki/Chat) (don't just cc him here, he won't see it! *He's on Discord!*).\n\nIf you are not sure if you need tests, consider this rule of thumb: the purpose of a test is to make sure someone doesn't accidentally revert the fix. Ask yourself, **is there anything in your PR that you feel it is important we not accidentally revert back to how it was before your fix?**\n\n__Reviewers__: Read the [Tree Hygiene page](https://github.com/flutter/flutter/wiki/Tree-hygiene#how-to-review-code) and make sure this patch meets those guidelines before LGTMing.", "createdAt": "2022-09-16T23:25:13Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/111790#issuecomment-1249933235"}, {"id": "IC_kwDOAeUeuM5KgJEf", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "Test passes here.\r\n\r\n![image](https://user-images.githubusercontent.com/5236035/190831012-234ae33d-f37c-4e0a-99b9-bd80d69f269e.png)\r\n\r\nWithout the fix, test fails:\r\n\r\n![image](https://user-images.githubusercontent.com/5236035/190831030-f94e8921-6473-464d-96a6-e92d49a4739a.png)\r\n![image](https://user-images.githubusercontent.com/5236035/190831125-e3fa19ff-6496-41fa-8a4f-6c421438c4c0.png)\r\n", "createdAt": "2022-09-16T23:45:23Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/111790#issuecomment-1249939743"}, {"id": "IC_kwDOAeUeuM5KgRb-", "author": {"login": "auto-submit"}, "authorAssociation": "NONE", "body": "auto label is removed for flutter/flutter, pr: 111790, due to - Please get at least one approved review if you are already a member or two member reviews if you are not a member before re-applying this label. __Reviewers__: If you left a comment approving, please use the \"approve\" review action instead.", "createdAt": "2022-09-17T01:50:37Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/111790#issuecomment-1249974014"}, {"id": "IC_kwDOAeUeuM5KgRb_", "author": {"login": "auto-submit"}, "authorAssociation": "NONE", "body": "auto label is removed for flutter/flutter, pr: 111790, due to Validations Fail.", "createdAt": "2022-09-17T01:50:38Z", "includesCreatedEdit": false, "isMinimized": false, "minimizedReason": "", "reactionGroups": [], "url": "https://github.com/flutter/flutter/pull/111790#issuecomment-1249974015"}, {"id": "IC_kwDOAeUeuM5KgRnz", "author": {"login": "fzyzcjy"}, "authorAssociation": "CONTRIBUTOR", "body": "Oops seems to because need 2 approvals", "createdAt": "2022-09-17T01:54:58Z", "includesCreatedEdit": true, "isMinimized": false, "minimizedReason": "", "reactionGroups": [{"content": "LAUGH", "users": {"totalCount": 1}}], "url": "https://github.com/flutter/flutter/pull/111790#issuecomment-1249974771"}], "createdAt": "2022-09-16T23:25:10Z", "title": "Fix UiKitView which wrongly unconditionally repaints"}}